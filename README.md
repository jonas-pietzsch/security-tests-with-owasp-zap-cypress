# DevSecOps: Testing Web Apps w/ Cypress & OWASP ZAP

1. [Cypress](https://www.cypress.io) is an UI/E2E testing framework for web applications. You know Selenium? Cypress is more awesome in every aspect. [See why in an article by me](https://blog.codecentric.de/en/2020/10/cypress-ui-end2end-testing/)
2. [OWASP ZAP](https://www.zaproxy.org/) is web app security scanner. It gathers traffic using a proxy, further explore, passive and active scan web applications for potential vulnerabilities.
3. [OWASP Juice Shop](https://owasp.org/www-project-juice-shop/) is an intentionally insecure web application for training and education purposes.

## Why and How?
### Combining two great tools for a greater goal

These tools can be combined in an interesting way. **Cypress** can proxy all of its traffic generated during test execution through **OWASP ZAP**. ZAP will roughly learn which sites the web app under test has. It gathers security alerts found in the traffic. Afterwards ZAP can run active scans against the application in addition. These try some active attacks against the site, such as SQL injections or Cross-Site-Scripting attempts. OWASP ZAP afterwards provides reports including all found vulnerabilities.

### OWASP Juice Shop as demo application

The famous JS has a fair amount of serious vulnerabilities. Therefor it's perfect for demonstrating what kind of vulnerabilities and smells can be discovered with automated click tests and active scanning.

## Running it

### Locally against remote Juice Shop

Juice Shop is up already on: https://juice-shop.herokuapp.com

Start OWASP ZAP in headless mode using Docker, as we just need its HTTP API, on `http://localhost:8080`:

```bash
docker run -u zap -p 8080:8080 jverhoelen/owasp-zap-with-entrypoint
# this image is a variant of https://github.com/zaproxy/zaproxy/blob/develop/docker/Dockerfile-bare
# it has been built from file https://github.com/jverhoelen/zaproxy/blob/develop/docker/Dockerfile-bare-entrypoint
# it just runs ZAP as Docker entrypoint using its bash script wrapper zap.sh with some default arguments so it binds to 0.0.0.0:8080 as daemon without API key
```

Configure ZAP as proxy for Cypress and run tests:

```bash
nvm use
npm i

export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080

npm run remote:cypress
npm run remote:zap-active-scan
# or "npm run remote:all" for both after another
```

### Locally against dockerized Juice Shop (on Windows)

Run dockerized JuiceShop locally 


```bash
docker run --rm -p 3000:3000 bkimminich/juice-shop

# https://hub.docker.com/r/bkimminich/juice-shop
```
Run dockerized Owasp ZAP locally

```bash
docker run -u zap -p 8080:8080 -i owasp/zap2docker-stable zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true -config api.key=123456

# 123456 is sample api key
```

Configure Owasp ZAP as a proxy for Cypress

```bash
set HTTP_PROXY=http://localhost:8080
set "NO_PROXY=<-loopback>"

set CYPRESS_BASE_URL=http://host.docker.internal:3000

# Cypress proxy configuration https://docs.cypress.io/guides/references/proxy-configuration.html#Set-a-proxy-on-Linux-or-macOS
# host.docker.interal works only on Windows. See https://docs.docker.com/docker-for-windows/networking/
```

Start Cypress and run test 

```bash
npm start
```
Check out the alerts generated by Owasp ZAP [http://localhost:8080/JSON/alert/view/alerts/?apikey=123456 ](http://localhost:8080/JSON/alert/view/alerts/?apikey=123456 )



